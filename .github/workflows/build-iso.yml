name: Build iStoreOS ISO from img.gz

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:
    inputs:
      isstoreos_version:
        description: 'iStoreOS Version (optional)'
        required: false
        default: ''

jobs:
  build-iso:
    runs-on: ubuntu-latest
    name: Build iStoreOS ISO
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Set up build environment
        run: |
          sudo apt update
          sudo apt install -y \
            live-build \
            debootstrap \
            squashfs-tools \
            xorriso \
            qemu-utils \
            gzip \
            wget \
            curl \
            jq
      
      - name: Download img.gz from current repo latest release
        id: download
        run: |
          # 获取当前仓库的最新Release
          REPO_OWNER="${{ github.repository_owner }}"
          REPO_NAME="${{ github.event.repository.name }}"
          
          # 使用GitHub API获取当前仓库最新Release的资产
          LATEST_RELEASE=$(curl -s "https://api.github.com/repos/$REPO_OWNER/$REPO_NAME/releases/latest")
          
          # 查找img.gz文件
          IMG_URL=$(echo "$LATEST_RELEASE" | jq -r '.assets[] | select(.name | endswith(".img.gz")) | .browser_download_url')
          
          if [ -z "$IMG_URL" ]; then
            echo "Error: No .img.gz file found in latest release" >&2
            exit 1
          fi
          
          IMG_NAME=$(basename "$IMG_URL")
          wget -O "$IMG_NAME" "$IMG_URL"
          
          echo "img_name=$IMG_NAME" >> $GITHUB_OUTPUT
          # 生成对应的ISO文件名
          ISO_NAME="${IMG_NAME%.img.gz}.iso"
          echo "iso_name=$ISO_NAME" >> $GITHUB_OUTPUT
      
      - name: Extract img file
        run: |
          IMG_NAME=${{ steps.download.outputs.img_name }}
          gunzip "$IMG_NAME"
      
      - name: Make conversion script executable
        run: chmod +x convert.sh
      
      - name: Run conversion script
        run: |
          IMG_NAME=${{ steps.download.outputs.img_name }}
          ISO_NAME=${{ steps.download.outputs.iso_name }}
          sudo ./convert.sh "${IMG_NAME%.img.gz}.img" "$ISO_NAME"
        id: convert
        continue-on-error: true
      
      - name: Upload build logs on failure
        if: steps.convert.outcome != 'success'
        uses: actions/upload-artifact@v4
        with:
          name: build-logs-${{ steps.download.outputs.iso_name }}
          path: |
            /tmp/istoreos-iso-build/live-build/build.log
            /tmp/istoreos-iso-build/live-build/config
          retention-days: 90
      
      - name: Upload ISO artifact
        if: steps.convert.outcome == 'success'
        uses: actions/upload-artifact@v4
        with:
          name: ${{ steps.download.outputs.iso_name }}
          path: ${{ steps.download.outputs.iso_name }}
          retention-days: 90
