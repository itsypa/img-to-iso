name: Build iStoreOS ISO from img.gz

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:
    inputs:
      isstoreos_version:
        description: 'iStoreOS Version (optional)'
        required: false
        default: ''

jobs:
  build-iso:
    runs-on: ubuntu-latest
    name: Build iStoreOS ISO
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Set up build environment
        run: |
          sudo apt update
          sudo apt install -y \
            live-build \
            debootstrap \
            squashfs-tools \
            xorriso \
            qemu-utils \
            gzip \
            wget \
            curl \
            jq
      
      - name: Download iStoreOS img.gz
        id: download
        run: |
          if [ -n "${{ github.event.inputs.isstoreos_version }}" ]; then
            VERSION=${{ github.event.inputs.isstoreos_version }}
            IMG_NAME="istoreos-x86-64-generic-squashfs-combined.img.gz"
            wget -O "$IMG_NAME" https://github.com/istoreos/istoreos/releases/download/v${VERSION}/$IMG_NAME
          else
            # Get latest release
            LATEST_RELEASE=$(curl -s https://api.github.com/repos/istoreos/istoreos/releases/latest)
            IMG_URL=$(echo $LATEST_RELEASE | jq -r '.assets[] | select(.name | contains("x86-64-generic-squashfs-combined.img.gz")) | .browser_download_url')
            IMG_NAME=$(basename "$IMG_URL")
            wget -O "$IMG_NAME" "$IMG_URL"
          fi
          echo "img_name=$IMG_NAME" >> $GITHUB_OUTPUT
          # 生成对应的ISO文件名
          ISO_NAME="${IMG_NAME%.img.gz}.iso"
          echo "iso_name=$ISO_NAME" >> $GITHUB_OUTPUT
      
      - name: Extract img file
        run: |
          IMG_NAME=${{ steps.download.outputs.img_name }}
          gunzip "$IMG_NAME"
      
      - name: Make conversion script executable
        run: chmod +x convert.sh
      
      - name: Run conversion script
        run: |
          IMG_NAME=${{ steps.download.outputs.img_name }}
          ISO_NAME=${{ steps.download.outputs.iso_name }}
          sudo ./convert.sh "${IMG_NAME%.img.gz}.img" "$ISO_NAME"
        id: convert
        continue-on-error: true
      
      - name: Upload build logs on failure
        if: steps.convert.outcome != 'success'
        uses: actions/upload-artifact@v4
        with:
          name: build-logs-${{ steps.download.outputs.iso_name }}
          path: |
            /tmp/istoreos-iso-build/live-build/build.log
            /tmp/istoreos-iso-build/live-build/config
          retention-days: 90
      
      - name: Upload ISO artifact
        if: steps.convert.outcome == 'success'
        uses: actions/upload-artifact@v4
        with:
          name: ${{ steps.download.outputs.iso_name }}
          path: ${{ steps.download.outputs.iso_name }}
          retention-days: 90
